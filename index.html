<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAHJONG ZEN - DUAL MODES</title>
    <style>
        :root { --t-w: 62px; --t-h: 84px; --zen-bg: #0c0a09; --ivory: #f5f5f4; --gold: #d97706; }
        body { margin: 0; background: var(--zen-bg); font-family: "Palatino", serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; color: #a8a29e; }
        header { padding: 15px; text-align: center; border-bottom: 1px solid #292524; background: rgba(0,0,0,0.4); }
        .zen-title { font-size: 22px; font-weight: 200; letter-spacing: 8px; color: #fafaf9; margin-bottom: 5px; cursor: pointer; }
        #game-area { position: relative; flex-grow: 1; display: flex; justify-content: center; align-items: center; perspective: 1200px; }
        #board { position: relative; width: 400px; height: 500px; transform: rotateX(10deg); transform-style: preserve-3d; transition: opacity 0.5s; }
        .tile { position: absolute; width: var(--t-w); height: var(--t-h); background: var(--ivory); border-radius: 4px; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1.5px solid #1c1917; box-shadow: 0 1px 0 #d6d3d1, 1px 2px 0 #d6d3d1, 2px 3px 0 #78716c, 4px 10px 25px rgba(0,0,0,0.8); transition: all 0.3s ease; }
        .tile .symbol { font-size: 56px; line-height: 0; user-select: none; filter: grayscale(1) brightness(0) contrast(1000%); opacity: 0.85; transform: translateY(-4px); display: inline-block; }
        .tile.selected { background: #fff; transform: translateZ(30px) scale(1.05); box-shadow: 0 20px 50px rgba(217,119,6,0.3); border-color: var(--gold); }
        .tile.locked { filter: contrast(0.5) brightness(0.2); cursor: not-allowed; opacity: 0.4; }
        .tile.hint { outline: 4px solid var(--gold); animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.5; } }
        #onboarding-overlay, #success-overlay, #leaderboard-overlay, #mode-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .step-box { max-width: 320px; padding: 40px; border: 1px solid #444; background: #1c1917; }
        .step-text { font-size: 18px; margin-bottom: 30px; letter-spacing: 2px; color: #d6d3d1; }
        footer { padding: 25px; display: flex; justify-content: center; gap: 10px; border-top: 1px solid #222; }
        .zen-btn { padding: 10px 20px; background: transparent; border: 1px solid #444; color: #78716c; font-size: 11px; letter-spacing: 2px; cursor: pointer; transition: 0.3s; }
        .zen-btn:hover { color: #fafaf9; border-color: #a8a29e; }
        .mode-active { color: var(--gold) !important; border-color: var(--gold) !important; }
        .leaderboard-list { text-align: left; width: 100%; margin: 20px 0; font-family: monospace; font-size: 12px; }
        .leaderboard-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #333; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="mode-overlay" style="display:flex">
        <div class="step-box">
            <div class="step-text">SELECT MODE</div>
            <button class="zen-btn" style="width:100%;margin-bottom:15px" onclick="setMode('ZEN')">ZEN: Endless Journey</button>
            <button class="zen-btn" style="width:100%" onclick="setMode('TIME_ATTACK')">TIME ATTACK: 3-Level Rush</button>
        </div>
    </div>
    <div id="onboarding-overlay"><div class="step-box"><div id="step-msg" class="step-text">Welcome to Mahjong Zen.</div><button class="zen-btn" id="next-step">BEGIN</button></div></div>
    <div id="success-overlay"></div>
    <div id="leaderboard-overlay">
        <div class="step-box">
            <div class="step-text">HALL OF FAME</div>
            <div id="leaderboard-content" class="leaderboard-list"></div>
            <button class="zen-btn" onclick="document.getElementById('leaderboard-overlay').style.display='none'">CLOSE</button>
        </div>
    </div>
    <header>
        <div class="zen-title" onclick="showLeaderboard()">MAHJONG ZEN</div>
        <div id="game-status" style="font-size: 10px; letter-spacing: 2px;">
            MODE: <span id="display-mode" style="color:var(--gold)">-</span> | 
            LVL: <span id="level-num">1</span> | 
            TIME: <span id="timer">00:00</span>
        </div>
    </header>
    <div id="game-area"><div id="board"></div></div>
    <footer>
        <button class="zen-btn" onclick="undo()">UNDO</button>
        <button class="zen-btn" onclick="showHint()">HINT</button>
        <button class="zen-btn" onclick="document.getElementById('mode-overlay').style.display='flex'">MODES</button>
        <button class="zen-btn" onclick="init()">RESET</button>
    </footer>
    <script>
        const board = document.getElementById('board'); const countEl = document.getElementById('count');
        const levelEl = document.getElementById('level-num'); const timerEl = document.getElementById('timer');
        const modeEl = document.getElementById('display-mode');
        const mahjongs = ['ðŸ€„','ðŸ€…','ðŸ€†','ðŸ€‡','ðŸ€ˆ','ðŸ€‰','ðŸ€Š','ðŸ€‹','ðŸ€Œ','ðŸ€','ðŸ€ž','ðŸ€Ÿ','ðŸ€','ðŸ€‘','ðŸ€’','ðŸ€“','ðŸ€”','ðŸ€•','ðŸ€–','ðŸ€—','ðŸ€™','ðŸ€š','ðŸ€›'];
        
        const LEVELS = {
            1: { layout: () => { const l = []; for(let r=0;r<4;r++) for(let c=0;c<4;c++) l.push({r,c,l:0}); return l; }},
            2: { layout: () => { const l = []; for(let r=0;r<6;r++) { l.push({r,c:0,l:0},{r,c:3,l:0}); } for(let r=1;r<5;r++) { l.push({r,c:0.5,l:1},{r,c:2.5,l:1}); } return l; }},
            3: { layout: () => { const l = []; for(let r=0;r<6;r++) for(let c=0;c<4;c++) l.push({r,c,l:0}); for(let r=1;r<5;r++) for(let c=1;c<3;c++) l.push({r:r+0.2,c:c+0.2,l:1}); for(let r=2;r<4;r++) l.push({r:r+0.4,c:1.7,l:2}); return l; }}
        };

        let currentMode = localStorage.getItem('zenActiveMode') || 'ZEN';
        let currentLevel = 1;
        let totalLevelsCleared = parseInt(localStorage.getItem('zenTotalCleared')) || 0;
        let selected = null; let all = []; let history = []; let audioCtx = null;
        let startTime = null; let timerInterval = null; let speedrunStartTime = null;

        function initAudio() { if(!audioCtx) audioCtx = new(window.AudioContext||window.webkitAudioContext)(); }
        function playZenSound(f, type="sine", d=0.5, v=0.02) {
            initAudio(); const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = type; o.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.setValueAtTime(v, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d);
            o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d);
        }

        function setMode(mode) {
            currentMode = mode; localStorage.setItem('zenActiveMode', mode);
            document.getElementById('mode-overlay').style.display = 'none';
            currentLevel = 1; speedrunStartTime = Date.now();
            init();
        }

        function updateTimer() {
            if(!startTime) return;
            const diff = Math.floor((Date.now() - (currentMode === 'TIME_ATTACK' ? speedrunStartTime : startTime)) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            timerEl.innerText = `${m}:${s}`;
        }

        function showSuccess() {
            clearInterval(timerInterval);
            const timeTaken = Math.floor((Date.now() - (currentMode === 'TIME_ATTACK' ? speedrunStartTime : startTime)) / 1000);
            
            if(currentMode === 'ZEN') {
                totalLevelsCleared++;
                localStorage.setItem('zenTotalCleared', totalLevelsCleared);
                saveScore('ZEN', totalLevelsCleared);
            }

            const s = document.getElementById('success-overlay');
            s.style.display = 'flex';
            
            if(currentMode === 'TIME_ATTACK' && currentLevel === 3) {
                saveScore('SPEEDRUN', timeTaken);
                s.innerHTML = `<div class="step-box"><div class="step-text">SPEEDRUN COMPLETE</div><div style="color:var(--gold)">TIME: ${timerEl.innerText}</div><button class="zen-btn" onclick="setMode('TIME_ATTACK')">RETRY</button></div>`;
            } else {
                s.innerHTML = `<div class="step-box"><div class="step-text">LEVEL COMPLETE</div><button class="zen-btn" onclick="nextLevel()">CONTINUE</button></div>`;
            }
            playZenSound(880, "triangle", 1, 0.03);
        }

        function saveScore(type, val) {
            let key = type === 'ZEN' ? 'zenScores_Endless' : 'zenScores_Speedrun';
            let scores = JSON.parse(localStorage.getItem(key) || '[]');
            scores.push({ val: val, date: new Date().toLocaleDateString() });
            scores.sort((a,b) => type === 'ZEN' ? b.val - a.val : a.val - b.val);
            localStorage.setItem(key, JSON.stringify(scores.slice(0,5)));
        }

        function showLeaderboard() {
            const overlay = document.getElementById('leaderboard-overlay');
            const content = document.getElementById('leaderboard-content');
            let s1 = JSON.parse(localStorage.getItem('zenScores_Endless') || '[]');
            let s2 = JSON.parse(localStorage.getItem('zenScores_Speedrun') || '[]');
            
            content.innerHTML = `
                <div style="color:var(--gold);margin-bottom:5px">ENDLESS (Levels)</div>
                ${s1.map(s=>`<div class="leaderboard-item"><span>${s.date}</span><span>${s.val} Lvl</span></div>`).join('')}
                <div style="color:var(--gold);margin-top:15px;margin-bottom:5px">SPEEDRUN (Time)</div>
                ${s2.map(s=>`<div class="leaderboard-item"><span>${s.date}</span><span>${s.val}s</span></div>`).join('')}
            `;
            overlay.style.display = 'flex';
        }

        function nextLevel() {
            currentLevel = LEVELS[currentLevel + 1] ? currentLevel + 1 : (currentMode === 'ZEN' ? Math.floor(Math.random()*3)+1 : 1);
            document.getElementById('success-overlay').style.display = 'none';
            init();
        }

        function isLocked(t) {
            const {r,c,l} = t.dataset; const up = all.some(o => o.dataset.l > l && Math.abs(o.dataset.r-r)<0.7 && Math.abs(o.dataset.c-c)<0.7);
            if(up) return true; const left = all.some(o => o.dataset.l == l && Math.abs(o.dataset.r-r)<0.5 && o.dataset.c < c && o.dataset.c > c-1.1);
            const right = all.some(o => o.dataset.l == l && Math.abs(o.dataset.r-r)<0.5 && o.dataset.c > c && o.dataset.c < c+1.1); return left && right;
        }

        function handle(t) {
            if(t.classList.contains('locked')) return; initAudio();
            if(selected === t) { t.classList.remove('selected'); selected = null; return; }
            playZenSound(selected ? 600 : 400);
            if(selected) {
                if(selected.dataset.v === t.dataset.v) {
                    history.push([selected, t]); t.remove(); selected.remove();
                    all = all.filter(x => x!==t && x!==selected); selected = null;
                    playZenSound(800, "triangle", 1.2, 0.03); 
                    all.forEach(t => t.classList.toggle('locked', isLocked(t)));
                    if(all.length === 0) showSuccess();
                } else { selected.classList.remove('selected'); t.classList.add('selected'); selected = t; }
            } else { t.classList.add('selected'); selected = t; }
        }

        function undo() { if(!history.length) return; const last = history.pop(); last.forEach(t => { board.appendChild(t); all.push(t); }); all.forEach(t => t.classList.toggle('locked', isLocked(t))); }
        function showHint() {
            all.forEach(t => t.classList.remove('hint')); const free = all.filter(t => !isLocked(t));
            for(let i=0; i<free.length; i++) for(let j=i+1; j<free.length; j++) if(free[i].dataset.v === free[j].dataset.v) { free[i].classList.add('hint'); free[j].classList.add('hint'); return; }
        }

        function init() {
            board.innerHTML = ''; all = []; history = [];
            clearInterval(timerInterval); startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            modeEl.innerText = currentMode; levelEl.innerText = currentLevel;
            
            const layout = (LEVELS[currentLevel] || LEVELS[1]).layout();
            
            // ðŸ—ï¸ ä¿®å¤é€»è¾‘ï¼šç¡®ä¿æ€»æ•°æ˜¯å¶æ•°ä¸”ç‰Œé¢å®Œå…¨é…å¯¹
            let totalTiles = layout.length;
            if(totalTiles % 2 !== 0) {
                layout.pop(); // å¦‚æžœæ˜¯å¥‡æ•°ï¼Œå¼ºè¡ŒåŽ»æŽ‰ä¸€ä¸ªï¼Œç¡®ä¿èƒ½æˆå¯¹
                totalTiles = layout.length;
            }

            let pool = [];
            let pairsNeeded = totalTiles / 2;
            for(let i=0; i<pairsNeeded; i++) {
                const v = mahjongs[i % mahjongs.length];
                pool.push(v, v); // å¼ºåˆ¶åŠ å…¥ä¸€å¯¹
            }
            
            // éšæœºæ´—ç‰Œ
            pool.sort(() => Math.random() - 0.5);

            layout.forEach((p, i) => {
                const t = document.createElement('div'); t.className = 'tile';
                t.innerHTML = `<span class="symbol">${pool[i]}</span>`;
                Object.assign(t.dataset, {v:pool[i], r:p.r, c:p.c, l:p.l});
                // å¾®è°ƒé—´è·é˜²æ­¢é‡å æ„Ÿè¿‡å¼º
                t.style.left = `${p.c * 72 + 50}px`; t.style.top = `${p.r * 82 + 30}px`;
                t.style.transform = `translateZ(${p.l * 12}px)`; t.style.zIndex = p.l * 10;
                t.onclick = () => handle(t); board.appendChild(t); all.push(t);
            });
            all.forEach(t => t.classList.toggle('locked', isLocked(t)));
        }
        if(!localStorage.getItem('zenDone')) { document.getElementById('onboarding-overlay').style.display = 'flex'; document.getElementById('next-step').onclick = () => { localStorage.setItem('zenDone','1'); document.getElementById('onboarding-overlay').style.display='none'; init(); }; }
        else { init(); }
    </script>
</body>
</html>
